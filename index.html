<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rezervaƒçn√≠ n√°stƒõnka</title>
<style>

.view-switch {
  display: flex;
  gap: 40px;
  margin-top: 6px;
}

.switch-btn {
  padding: 8px 14px;
height: 42px;              /* ‚úÖ sjednocen√° v√Ω≈°ka */
  display: flex;             /* ‚úÖ vertik√°ln√≠ zarovn√°n√≠ textu */
  align-items: center;       /* ‚úÖ text p≈ôesnƒõ uprost≈ôed */

  border-radius: 12px;
  border: 1px solid #cdd3dd;
  background: rgba(255,255,255,0.85);
  cursor: pointer;
  font-size: 14px;
  transition: background .2s ease, transform .2s ease;
}

.switch-btn {
  position: relative;
}

.switch-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: 50%;
  background: #2b7cff;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #fff;
}

/* ‚úÖ Neaktivn√≠ ARCHIV ‚Äì svƒõtle ≈°ed√Ω jako bƒõ≈æn√Ω archivn√≠ den */
#viewArchiveBtn:not(.active) {
  background: linear-gradient(145deg, #e0e0e0, #c8c8c8) !important;
  border: 1px solid #b0b0b0 !important;
  color: #444 !important;
}

/* ‚úÖ Badge na ARCHIVU je v≈ædy ≈°ed√Ω ‚Äì i kdy≈æ nen√≠ aktivn√≠ */
#viewArchiveBtn .switch-badge {
  background: #6f6f6f !important;
  border-color: #fff !important;
  color: #fff !important;
}

.switch-btn.active {
  background: linear-gradient(90deg,#2b7cff,#00c6ff);
  color: #fff;
  border-color: rgba(255,255,255,.8);
  transform: translateY(-2px);
}

/* ‚úÖ Aktivn√≠ ARCHIV ‚Äì ≈°ed√Ω vzhled */
#viewArchiveBtn.active {
  background: linear-gradient(145deg, #8a8a8a, #6f6f6f) !important;
  border-color: #555 !important;
  color: #fff !important;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
  font-family: "Inter", Arial, sans-serif;
  background: linear-gradient(to bottom,#ffffff 0%,#f3f5f9 15%,#eef1f5 50%,#f3f5f9 85%,#ffffff 100%);
  min-height: 100vh;
  color: #222;
  box-sizing: border-box;
}
*, *::before, *::after { box-sizing: inherit; }
@keyframes fadeUp { from{opacity:0;transform:translateY(25px);} to{opacity:1;transform:translateY(0);} }
@keyframes fadeDown { from{opacity:0;transform:translateY(-25px);} to{opacity:1;transform:translateY(0);} }
@keyframes scaleIn { from{transform:scale(0.92);opacity:0;} to{transform:scale(1);opacity:1;} }
@keyframes successFlash { 0%{box-shadow:0 0 0 rgba(0,200,120,0);} 50%{box-shadow:0 0 22px rgba(0,200,120,0.45);} 100%{box-shadow:0 0 0 rgba(0,200,120,0);} }
@keyframes editPulse { 0%{transform:scale(1);filter:brightness(1);} 40%{transform:scale(1.03);filter:brightness(1.12);} 100%{transform:scale(1);filter:brightness(1);} }
.edit-highlight { animation: editPulse 0.45s ease-out; }
@keyframes pulseJump { 0%{box-shadow:0 0 0 rgba(76,175,80,0);transform:scale(1);} 40%{box-shadow:0 0 18px rgba(76,175,80,0.7);transform:scale(1.015);} 100%{box-shadow:0 0 0 rgba(76,175,80,0);transform:scale(1);} }
.jump-highlight { animation: pulseJump 1.2s ease-out; }
.success-flash { animation: successFlash 1.4s ease-out; }

.duplicate-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  --badge-offset: 32px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  color: #fff;
  display: inline-block;
  backdrop-filter: blur(4px);
  text-transform: uppercase;
  letter-spacing: .04em;
  cursor: pointer;
  z-index: 5;
}
@media (max-width:480px){
  .duplicate-badge{
    padding:3px 7px;
    font-size:10px;
    --badge-offset:26px;
  }
}
.duplicate-badge::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:-30px;
  right:0;
  background:rgba(0,0,0,.75);
  color:#fff;
  padding:4px 8px;
  border-radius:6px;
  font-size:11px;
  white-space:nowrap;
  opacity:0;
  transform:translateY(4px);
  pointer-events:none;
  transition:opacity .2s ease,transform .2s ease;
}
.duplicate-badge:hover::after{opacity:1;transform:translateY(0);}

.status-strip{
  position:absolute;
  left:0;
  top:0;
  width:8px;
  height:100%;
  border-radius:20px 0 0 20px;
}
.duplicate-dot{
  position:absolute;
  top:5px;
  left:14px;
  width:12px;
  height:12px;
  border-radius:50%;
}

.card.archive-card {
  background: rgba(240,240,240,0.9) !important;
  filter: grayscale(0.8);
}

.card.archive-card .status-strip,
.card.archive-card .duplicate-dot,
.card.archive-card .duplicate-badge {
  display: none !important;
}

.topbar{
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(12px);
  padding:14px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  box-shadow:0 4px 22px rgba(0,0,0,.08);
  animation:fadeDown .6s ease;
}
.logo-wrap img{
  height:46px;
  width:auto;
  max-width:100%;
}
.topbar-bottom{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  max-width:480px;
}
.topbar-bottom h1{
  margin:0;
  font-size:22px;
  font-weight:700;
  background:linear-gradient(90deg,#2b7cff,#00c6ff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.btn-primary{
  background:linear-gradient(90deg,#2b7cff,#00c6ff);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:14px;
  cursor:pointer;
  font-size:15px;
  font-weight:600;
  transition:transform .25s ease,box-shadow .25s ease;
}
.btn-primary:hover{
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 6px 18px rgba(43,124,255,.45);
}

.container{
  max-width:1000px;
  margin:32px auto;
  padding:0 16px 32px;

  display:grid;
  grid-template-columns:1fr;
  gap:20px;
}

@media(min-width:900px){
  .container{
    grid-template-columns:1fr 1fr; /* dvƒõ karty vedle sebe */
  }
}

/* ‚úÖ Kompaktn√≠ karta */
.card {
  position: relative;
  background-color: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);

  /* men≈°√≠ padding = okam≈æitƒõ ni≈æ≈°√≠ karta */
  padding: calc(14px + var(--badge-offset,0px)) 16px 14px 18px;

  border-radius: 20px;
  box-shadow: 0 8px 26px rgba(0,0,0,.08);
  margin-bottom: 16px;

  display: flex;
  flex-direction: column;
  justify-content: flex-start;

  /* men≈°√≠ mezery mezi prvky */
  gap: 8px;

  flex-wrap: nowrap;
  opacity: 0;
  transform: translateY(25px);
  animation: fadeUp .55s ease forwards;
  transition: transform .25s ease, box-shadow .25s ease, background-color .25s ease, filter .2s ease;
}

@media(max-width:480px){
  .card {
    flex-direction: column;
    gap: 8px;
    padding-right: 14px;
  }
}

/* ‚úÖ Kompaktn√≠ zelen√° karta */
.card.green {
  background-color: rgba(226,245,228,.95);
}

.card.duplicate-hover {
  filter: brightness(1.03);
}

/* ‚úÖ Kompaktn√≠ text uvnit≈ô karty */
.card-info {
  font-size: 15px;

  /* men≈°√≠ line-height = karta je ni≈æ≈°√≠ */
  line-height: 1.45;

  flex: 1;
  word-break: keep-all;
  white-space: normal;
}

/* ‚úÖ Kompaktn√≠ akce */
.actions {
  display: flex;
  flex-direction: column;
  align-items: center;

  /* men≈°√≠ mezera nad tlaƒç√≠tky */
  margin-top: 6px;
}

.actions-row {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 12px;
  width: 100%;
}

/* posun obsahu dol≈Ø na kart√°ch s DUPLICITOU, aby byl odstup od praporku */
.card.card-duplicate-bg {
  --badge-offset: 6px;
}

@media (max-width:480px) {
  .card.card-duplicate-bg {
    --badge-offset: 8px; /* na mobilu o nƒõco v√≠c m√≠sta */
  }
}

.icon-btn{
  min-width:70px;          /* obd√©ln√≠k jako dny v kalend√°≈ôi */
  height:42px;
  border-radius:14px;
  border:1px solid rgba(180,190,210,.9);
  box-shadow:0 6px 14px rgba(15,23,42,.18),0 1px 0 rgba(255,255,255,.9) inset;
  cursor:pointer;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform .2s ease, box-shadow .2s ease;
  margin:0 10px;           /* m√≠rn√© odsazen√≠ od st≈ôedu */
}

/* EDIT ‚Äì modr√Ω p≈ôechod */
.icon-btn.edit-btn{
  background:linear-gradient(145deg,#ffffff,#e5f0ff);
  border-color:#7ab3ff;
}
.icon-btn.edit-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 20px rgba(43,124,255,.35),0 1px 0 rgba(255,255,255,.95) inset;
}

/* DELETE ‚Äì ƒçerven√Ω p≈ôechod */
.icon-btn.delete-btn{
  background:linear-gradient(145deg,#fff5f5,#ffe0e0);
  border-color:#ff8a8a;
}
.icon-btn.delete-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 20px rgba(255,76,76,.35),0 1px 0 rgba(255,255,255,.95) inset;
}
.check-wrapper{
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:10px;
  font-size:14px;
}
.check-wrapper input{
  width:20px;
  height:20px;
  accent-color:#2b7cff;
}

.day-badge{
  position:absolute;
  top:4px;
  right:4px;
  min-width:20px;
  height:20px;
  padding:0 6px;
  border-radius:50%;
  border:2px solid #2b7cff;
  background:#fff;
  color:#2b7cff;
  font-size:11px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
}

.day-duplicate-dot{
  position:absolute;
  left:4px;
  width:12px;
  height:12px;
  border-radius:50%;
  font-size:9px;
  font-weight:700;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

.top-calendar-wrapper{
  width:100%;
  max-width:1000px;
  margin:8px auto 0;
  padding:0 16px;
}

.archive-day-selector {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 8px 2px 6px;
  -webkit-overflow-scrolling: touch;
}

.archive-day-selector::-webkit-scrollbar {
  height: 10px;
}

.archive-day-selector::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,.16);
  border-radius: 999px;
}

.archive-day-btn {
  position: relative;
  min-width: 70px;
  padding: 8px 10px;
  border-radius: 14px;

  /* ‚úÖ v√Ωraznƒõ ≈°ediv√Ω archivn√≠ vzhled */
  background: linear-gradient(145deg, #e0e0e0, #c8c8c8);
  border: 1px solid #b0b0b0;
  color: #444;

  text-align: center;
  font-size: 12px;
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
}

.archive-day-btn:hover {
  background: linear-gradient(145deg, #d5d5d5, #bfbfbf);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,.18);
}

.archive-day-btn.selected {
  background: linear-gradient(145deg, #8a8a8a, #6f6f6f); /* v√Ωraznƒõ tmav≈°√≠ */
  border-color: #555;
  color: #fff; /* lep≈°√≠ kontrast */
  box-shadow: 0 12px 22px rgba(0,0,0,.35);
  transform: translateY(-2px) scale(1.03); /* jemn√© zv√Ωraznƒõn√≠ */
}

.archive-day-btn.archive-weekend {
  background: linear-gradient(145deg, #e8e0d5, #d6c7b4);
  border-color: #b89c7a;
}
.archive-day-btn strong {
  display: block;
  font-size: 14px;
}

.archive-day-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
}

.archive-day-btn.archive-weekend {
  background: #f9f0e3;
  border-color: #e3b073;
}

.archive-day-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: 50%;
  background: #8f8f8f;
  color: #ffffff;
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

.top-calendar-label{
  font-size:13px;
  opacity:.7;
  margin:2px 2px 4px;
}

.top-day-selector{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding:8px 2px 6px;
  -webkit-overflow-scrolling:touch;
}
.top-day-selector::-webkit-scrollbar{height:12px;}
.top-day-selector::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,.15);
  border-radius:999px;
}
.top-day-selector::-webkit-scrollbar-thumb:hover{
  background: rgba(0,0,0,0.35);
}

@keyframes wowBounce{
  0%{transform:translateY(0) scale(1);box-shadow:0 10px 25px rgba(0,0,0,.18);}
  40%{transform:translateY(-4px) scale(1.04);box-shadow:0 16px 32px rgba(0,0,0,.25);}
  100%{transform:translateY(-2px) scale(1.02);box-shadow:0 12px 26px rgba(0,0,0,.2);}
}
.top-day-btn{
  position:relative;
  min-width:70px;
  padding:8px 10px;
  border-radius:14px;
  background:linear-gradient(145deg,#ffffff,#e5ebf7);
  border:1px solid rgba(180,190,210,.9);
  box-shadow:0 10px 20px rgba(15,23,42,.18),0 1px 0 rgba(255,255,255,.9) inset;
  text-align:center;
  font-size:12px;
  cursor:pointer;
  transition:transform .2s ease,box-shadow .2s ease;
}
.top-day-btn strong{display:block;font-size:14px;}
.top-day-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 24px rgba(15,23,42,.22),0 1px 0 rgba(255,255,255,.95) inset;
}
.top-day-btn.top-weekend{
  background:linear-gradient(145deg,#fff6e9,#ffe0b8);
  border-color:#ffb366;
}
.top-day-btn.top-selected{
  background:linear-gradient(145deg,#2b7cff,#00c6ff);
  color:#fff;
  border-color:rgba(255,255,255,.8);
  box-shadow:0 16px 30px rgba(0,76,175,.45),0 1px 0 rgba(255,255,255,.9) inset;
  animation:wowBounce .35s ease-out;
}
.top-day-btn.top-selected .day-badge{
  border-color:#fff;
  color:#2b7cff;
}

.modal-bg{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  justify-content:center;
  align-items:center;
  z-index:20;
}
.modal{
  background:rgba(255,255,255,.98);
  backdrop-filter:blur(16px);
  padding:22px;
  border-radius:20px;
  width:92%;
  max-width:420px;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  animation:scaleIn .4s ease;
}
.modal h2{
  margin:0 0 14px;
  font-size:19px;
  font-weight:600;
}

input,select{
  width:100%;
  padding:10px 11px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #d5d9e0;
  background:rgba(250,251,252,.95);
  font-size:14px;
  transition:border .2s ease,box-shadow .2s ease,background .2s ease;
}
input:focus,select:focus{
  border-color:#2b7cff;
  background:#fff;
  box-shadow:0 0 0 2px rgba(43,124,255,.22);
  outline:none;
}
.input-error{
  border-color:#e53935!important;
  box-shadow:0 0 0 2px rgba(229,57,53,.18)!important;
}

.phone-row{
  display:flex;
  gap:8px;
  width:100%;
}
.phone-row select{width:38%;}
.phone-row input{width:62%;}

.btn-row{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:8px;
}
.btn-close{
  background:#c9ced6;
  color:#222;
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  transition:background .2s ease,transform .2s ease;
}
.btn-close:hover{
  background:#b8bdc7;
  transform:translateY(-1px);
}

.name-option{
  padding:9px 11px;
  background:#f5f7fa;
  border-radius:10px;
  margin-bottom:6px;
  cursor:pointer;
  font-size:14px;
  transition:background .2s ease,transform .2s ease,box-shadow .2s ease;
}
.name-option:hover{
  background:#e6eefc;
  transform:translateX(4px);
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.filter-info{
  max-width:1000px;
  margin:4px auto 0;
  padding:0 16px;
  font-size:13px;
  opacity:.7;
}
.filter-info strong{font-weight:600;}

.day-selector{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding-bottom:8px;
  margin-bottom:10px;
}
.day-selector::-webkit-scrollbar{height:10px;}
.day-selector::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,.16);
  border-radius:999px;
}
.day-btn{
  position:relative;
  background:rgba(255,255,255,.95);
  border:1px solid #ddd;
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer;
  min-width:68px;
  text-align:center;
  font-size:12px;
  transition:background .2s ease,transform .2s ease,box-shadow .2s ease,border-color .2s ease;
}
.day-btn:hover{
  transform:translateY(-2px) scale(1.05);
  box-shadow:0 4px 12px rgba(0,0,0,.12);
}
.day-btn.selected{
  background:linear-gradient(90deg,#2b7cff,#00c6ff);
  color:#fff;
  border-color:#2b7cff;
}
.weekend{
  background:#fff4e6;
  border-color:#ffb366;
}

/* ‚úÖ Zkontrolovan√° + duplicitn√≠ */
.card.green.card-duplicate-bg {
  background:
    /* fade doprava ‚Äì jemn√Ω, nezaƒç√≠n√° hned u li≈°ty */
    linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,0.55) 65%,
      rgba(255,255,255,1) 100%
    ),
    /* tv≈Øj vertik√°ln√≠ p≈ôechod */
    linear-gradient(
      to bottom,
      var(--dup-bg-color-start) 0%,
      var(--dup-bg-color-mid) 6%,
      rgba(76,175,80,0.22) 20%,
      rgba(76,175,80,0) 100%
    ) !important;
}

/* ‚úÖ Duplicitn√≠ karta bez kontroly ‚Äì karta z≈Øst√°v√° b√≠l√°, jen horn√≠ fade */
.card.card-duplicate-bg:not(.green) {
  background:
    /* fade doprava */
    linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,0.55) 65%,
      rgba(255,255,255,1) 100%
    ),
    /* horn√≠ barevn√Ω pruh duplicity */
    linear-gradient(
      to bottom,
      var(--dup-bg-color-start) 0%,
      var(--dup-bg-color-mid) 6%,
      rgba(255,255,255,0) 20%
    ) !important;
}

/* ‚úÖ Jen zkontrolovan√° */
.card.green:not(.card-duplicate-bg) {
  background:
    /* fade doprava */
    linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,0.55) 65%,
      rgba(255,255,255,1) 100%
    ),
    /* tv≈Øj vertik√°ln√≠ p≈ôechod */
    linear-gradient(
      to bottom,
      rgba(76,175,80,0.22) 0%,
      rgba(76,175,80,0) 100%
    ) !important;
}

.archive-mini-card {
  background: rgba(240,240,240,0.9);
  border: 1px solid #d0d0d0;
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #444;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background .2s ease, transform .2s ease;
}

.archive-mini-card:hover {
  background: rgba(225,225,225,0.95);
  transform: translateY(-2px);
}

.archive-mini-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.archive-mini-time {
  font-weight: 600;
  color: #333;
}

.archive-mini-name {
  font-size: 13px;
}

.archive-mini-evc {
  background: #b0b0b0;
  color: #fff;
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 700;
}

.archive-expanded-card {
  background: rgba(245,245,245,0.95);
  border: 1px solid #d0d0d0;
  border-radius: 18px;
  padding: 18px 20px;
  margin-bottom: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  animation: fadeUp .35s ease;
}

.archive-expanded-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
  color: #333;
}

.archive-expanded-line {
  font-size: 14px;
  margin: 4px 0;
  color: #444;
}

.archive-expanded-close {
  text-align: right;
  margin-top: 10px;
}

.archive-expanded-close button {
  background: #ccc;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.archive-expanded-close button:hover {
  background: #bbb;
}

.archive-expanded-card {
  grid-row: span 2; /* ‚úÖ zabere v√Ω≈°ku dvou minikaret */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

@keyframes archiveExpand {
  0% {
    opacity: 0;
    transform: scale(0.92);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.archive-expand-anim {
  animation: archiveExpand 0.25s ease-out;
}

.archive-mini-time,
.top-day-btn strong,
.day-btn strong,
.archive-day-btn strong {
  font-size: 12px;
}

@keyframes calendarCascadeLeft {
  0% {
    opacity: 0;
    transform: translateX(-180px) scale(0.90);
  }
  55% {
    opacity: 1;
    transform: translateX(18px) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

@keyframes calendarCascadeRight {
  0% {
    opacity: 0;
    transform: translateX(180px) scale(0.90);
  }
  55% {
    opacity: 1;
    transform: translateX(-18px) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

/* ‚úÖ pomalej≈°√≠, majest√°tnƒõj≈°√≠ n√°jezd */
.calendar-animate-left > * {
  animation: calendarCascadeLeft 0.85s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.calendar-animate-right > * {
  animation: calendarCascadeRight 0.85s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* ‚úÖ vƒõt≈°√≠ zpo≈ædƒõn√≠ mezi dny */
.calendar-animate-left > *:nth-child(n) {
  animation-delay: calc(0.045s * var(--i));
}

.calendar-animate-right > *:nth-child(n) {
  animation-delay: calc(0.045s * var(--rev-i));
}

</style>
</head>

<body>

<div class="topbar">
  <div class="logo-wrap">
    <img src="https://www.stopcars.cz/wp-content/uploads/2024/08/stop_cars-logo_ok.svg" alt="StopCars logo">
  </div>
  <div class="topbar-bottom">
    <h1>Rezervaƒçn√≠ n√°stƒõnka</h1>
    <button class="btn-primary" onclick="openCreateModal()">+ P≈ôidat rezervaci</button>
  </div>
  <div class="view-switch">
   <button class="switch-btn" id="viewBoardBtn" onclick="switchView('board')">
  N√°stƒõnka <span class="switch-badge" id="boardCount"></span>
</button>

<button class="switch-btn" id="viewArchiveBtn" onclick="switchView('archive')">
  Archiv <span class="switch-badge" id="archiveCount"></span>
</button>
  </div>
</div>

<div class="top-calendar-wrapper">
  <div class="top-calendar-label">Rezervace na p≈ô√≠≈°t√≠ch 14 dn√≠</div>
  <div class="top-day-selector" id="topDaySelector"></div>
</div>

<div id="boardSearchWrapper" style="max-width:1000px; margin:10px auto 0; padding:0 16px;">
  <input 
    type="text" 
    id="boardSearchInput" 
    placeholder="Hledat na n√°stƒõnce (jm√©no, auto, EVC, telefon, email, technik‚Ä¶)" 
    oninput="handleBoardSearchInput(this.value)"
    style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid #ccd2dd; font-size:14px;">
</div>

<!-- ‚úÖ Archivn√≠ kalend√°≈ô ‚Äì 30 dn√≠ zpƒõt -->
<div id="archiveCalendarWrapper" style="display:none; max-width:1000px; margin:10px auto 0; padding:0 16px;">
  <div class="top-calendar-label">Archiv posledn√≠ch 30 dn√≠</div>
  <div class="archive-day-selector" id="archiveDaySelector"></div>
</div>

<div class="filter-info" id="filterInfo" style="display:none;">
  Filtrov√°no podle dne: <strong id="filterLabel"></strong> ‚Äì kliknut√≠m na stejn√Ω den filtr zru≈°√≠≈°.
</div>

<!-- ‚úÖ Vyhled√°v√°n√≠ a≈æ POD kalend√°≈ôem -->
<div id="archiveSearchWrapper" style="display:none; max-width:1000px; margin:10px auto 0; padding:0 16px;">
  <input 
    type="text" 
    id="archiveSearchInput" 
    placeholder="Hledat v archivu (jm√©no, auto, EVC, telefon, email‚Ä¶)" 
    oninput="handleArchiveSearchInput(this.value)"
    style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid #ccd2dd; font-size:14px;">
</div>

<div class="container" id="cardsContainer"></div>

<div class="modal-bg" id="modal">
  <div class="modal">
    <h2 id="modalTitle">Nov√° rezervace</h2>
    <div class="day-selector" id="daySelector"></div>
    <select id="timeInput">
  <option value="">Vyber ƒças</option>
  <option value="08:00">08:00</option>
  <option value="09:00">09:00</option>
  <option value="10:00">10:00</option>
  <option value="11:00">11:00</option>
  <option value="12:00">12:00</option>
  <option value="13:00">13:00</option>
  <option value="14:00">14:00</option>
  <option value="15:00">15:00</option>
  <option value="16:00">16:00</option>
  <option value="17:00">17:00</option>
  <option value="18:00">18:00</option>
  <option value="19:00">19:00</option>
</select>
    <input type="text" id="nameInput" placeholder="Jm√©no z√°kazn√≠ka">
    <div class="phone-row">
      <select id="prefix">
        <option value="+420" selected>üá®üáø +420</option>
        <option value="+421">üá∏üá∞ +421</option>
        <option value="+43">üá¶≈§ +43</option>
        <option value="+49">üá©üá™ +49</option>
        <option value="+36">üá≠üá∫ +36</option>
        <option value="+370">üá±≈§ +370</option>
      </select>
      <input type="number" id="phoneInput" placeholder="Telefon">
    </div>
    <input type="email" id="emailInput" placeholder="E‚Äëmail (voliteln√©)">
    <input type="text" id="carInput" placeholder="Vozidlo">
    <input type="number" id="evcInput" min="1" max="250" placeholder="Evidenƒçn√≠ ƒç√≠slo (1‚Äì250)">
    <div id="editControlRow" style="margin-bottom:6px;"></div>
    <div class="btn-row">
      <button class="btn-close" onclick="closeModal()">Zav≈ô√≠t</button>
      <button class="btn-primary" onclick="saveReservation()">Ulo≈æit</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="nameSelectModal">
  <div class="modal">
    <h2>Vyber technika</h2>
    <div class="name-option" onclick="selectTechnician('Martin Br√°zda')">Martin Br√°zda</div>
    <div class="name-option" onclick="selectTechnician('Martin Vlas√°k')">Martin Vlas√°k</div>
    <div class="name-option" onclick="selectTechnician('Miroslav La≈°√°k')">Miroslav La≈°√°k</div>
    <div class="name-option" onclick="selectTechnician('Michal Nasadil')">Michal Nasadil</div>
    <div class="name-option" onclick="selectTechnician('Roman Vlas√°k')">Roman Vlas√°k</div>
    <div class="name-option" onclick="selectTechnician('≈†tƒõp√°n Vespalec')">≈†tƒõp√°n Vespalec</div>
    <div class="btn-row">
      <button class="btn-close" onclick="closeNameSelect()">Zav≈ô√≠t</button>
    </div>
  </div>
</div>

<script>
let editId = null;
let pendingSaveData = null;
let selectingForCreation = false;
let changingControl = false;
let lastSavedId = null;
let activeFilterDate = null;
let currentView = 'board'; // 'board' nebo 'archive'
let boardSearchQuery = "";
let boardSearchTimer = null;

function getActiveSearchQuery() {
  if (currentView === 'board') {
    return boardSearchQuery.trim();
  }
  if (currentView === 'archive') {
    return archiveSearchQuery.trim();
  }
  return "";
}

function highlight(text) {
  const q = getActiveSearchQuery();
  if (!q) return text;

  const safe = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  const regex = new RegExp(safe, "gi");

  return text.replace(regex, match =>
    `<strong style="color:#d60000;">${match}</strong>`
  );
}

function handleBoardSearchInput(value) {
  boardSearchQuery = value.toLowerCase();

  clearTimeout(boardSearchTimer);
  boardSearchTimer = setTimeout(() => {
    renderReservations();
  }, 120);
}

function matchesBoardSearch(r) {
  if (!boardSearchQuery) return true;

  const fields = [
    r.name,
    r.phone,
    r.email,
    r.car,
    String(r.evc),
    r.date,
    r.time,
    r.technician || "",
    r.controlTechnician || ""
  ];

  const haystack = fields.join(" ").toLowerCase();
  return haystack.includes(boardSearchQuery);
}

function getReservations() {
  const list = JSON.parse(localStorage.getItem('reservations') || '[]');

  // dopln√≠me chybƒõj√≠c√≠ hodnoty u star√Ωch z√°znam≈Ø
  return list.map(function(r){
    if (!r.createdAt) r.createdAt = Date.now();
    if (typeof r.archived === 'undefined') r.archived = false;
    return r;
  });
}

function formatDayMonth(dateStr) {
  const d = new Date(dateStr + "T12:00:00");
  const day = String(d.getDate()).padStart(2, "0");
  const month = String(d.getMonth() + 1).padStart(2, "0");
  return `${day}.${month}.`;
}

function setReservations(list) {
  localStorage.setItem('reservations', JSON.stringify(list));
}

function formatDate(dateStr, timeStr) {
  const d = new Date(dateStr + 'T' + timeStr);
  if (isNaN(d.getTime())) return dateStr + ' ‚Äî ' + timeStr;
  const days = ['Nedƒõle','Pondƒõl√≠','√öter√Ω','St≈ôeda','ƒåtvrtek','P√°tek','Sobota'];
  const months = ['ledna','√∫nora','b≈ôezna','dubna','kvƒõtna','ƒçervna','ƒçervence','srpna','z√°≈ô√≠','≈ô√≠jna','listopadu','prosince'];
  return days[d.getDay()] + ' ' + d.getDate() + '. ' + months[d.getMonth()] + ' ‚Äî ' + timeStr;
}
function formatDateShort(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  if (isNaN(d.getTime())) return dateStr;
  const days = ['Ne','Po','√öt','St','ƒåt','P√°','So'];
  const months = ['1','2','3','4','5','6','7','8','9','10','11','12'];
  return days[d.getDay()] + ' ' + d.getDate() + '. ' + months[d.getMonth()] + '.';
}

// ‚úÖ 8 jasnƒõ odli≈°n√Ωch barev pro duplicity (bez zelen√©, bez ≈°ed√©)
const DUPLICATE_COLORS = [
  "#FF6B6B",
  "#FFA94D",
  "#FFD43B",
  "#4DABF7",
  "#74C0FC",
  "#9775FA",
  "#F06595",
  "#FAB005"
];

const usedDuplicateColors = new Map();
let duplicateColorIndex = 0;

function getColorForEvc(evc) {
  if (!evc && evc !== 0) return null;

  if (usedDuplicateColors.has(evc)) {
    return usedDuplicateColors.get(evc);
  }

  const color = DUPLICATE_COLORS[duplicateColorIndex % DUPLICATE_COLORS.length];
  duplicateColorIndex++;

  usedDuplicateColors.set(evc, color);
  return color;
}

// ‚úÖ Vr√°t√≠ poƒçty archivovan√Ωch rezervac√≠ podle data za posledn√≠ch 30 dn√≠ zpƒõt
function getArchiveCountsLast30Days() {
  const list = getReservations();
  const counts = {};

  const today = new Date();
  const todayMidnight = new Date(today.toISOString().split('T')[0] + "T00:00:00").getTime();
  const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

  list.forEach(function(r) {
    if (!r.archived) return;
    if (!r.date) return;

    const t = new Date(r.date + "T00:00:00").getTime();
    const diff = todayMidnight - t;

    if (diff < 0) return;          // budoucnost ignorujeme
    if (diff >= THIRTY_DAYS) return; // star≈°√≠ ne≈æ 30 dn√≠ ignorujeme

    counts[r.date] = (counts[r.date] || 0) + 1;
  });

  return counts;
}

// ‚úÖ Vykreslen√≠ archivn√≠ho kalend√°≈ôe 30 dn√≠ zpƒõt
function renderArchiveCalendar() {
  const wrapper = document.getElementById('archiveCalendarWrapper');
  const container = document.getElementById('archiveDaySelector');
  if (!wrapper || !container) return;

  container.innerHTML = "";

  const counts = getArchiveCountsLast30Days();

  const today = new Date();
 // generujeme od dnes - 30 po dnes - 1 (dne≈°ek se NEzobrazuje)
for (let offset = 30; offset >= 1; offset--) {
    const d = new Date();
    d.setDate(today.getDate() - offset);

    const iso = d.toISOString().split('T')[0];
    const weekday = ['Ne','Po','√öt','St','ƒåt','P√°','So'][d.getDay()];

    const btn = document.createElement('div');
    btn.style.setProperty('--i', 29 - offset);
    btn.style.setProperty('--rev-i', offset);
    btn.className = 'archive-day-btn';
    btn.dataset.date = iso;

    if (d.getDay() === 0 || d.getDay() === 6) {
      btn.classList.add('archive-weekend');
    }

    btn.innerHTML = weekday + '<br><strong>' + formatDayMonth(iso) + '</strong>';

    const count = counts[iso] || 0;
    if (count > 0) {
      const badge = document.createElement('div');
      badge.className = 'archive-day-badge';
      badge.textContent = count;
      btn.appendChild(badge);
    }

    btn.onclick = function() {
      if (activeFilterDate === iso) {
        activeFilterDate = null;
      } else {
        activeFilterDate = iso;
      }
      highlightArchiveSelected();
      renderReservations();
    };

    container.appendChild(btn);
  }

  highlightArchiveSelected();
}

function highlightArchiveSelected() {
  const buttons = document.querySelectorAll('.archive-day-btn');
  buttons.forEach(function(btn) {
    btn.classList.toggle('selected', btn.dataset.date === activeFilterDate);
  });
}

function switchView(view) {

  // ‚úÖ Reset filtr≈Ø pouze p≈ôi P≈òECHODU mezi re≈æimy
  if (currentView !== view) {
    if (view === 'archive') {
      // odch√°z√≠m z n√°stƒõnky ‚Üí reset dne
      activeFilterDate = null;
    }
    if (view === 'board') {
      // odch√°z√≠m z archivu ‚Üí reset dne + vyhled√°v√°n√≠
      activeFilterDate = null;
      archiveSearchQuery = "";
    }

    if (view === 'board') {
  boardSearchQuery = "";
  const input = document.getElementById('boardSearchInput');
  if (input) input.value = "";
}

  }

  // ‚úÖ Reset vizu√°ln√≠ho v√Ωbƒõru dne POUZE p≈ôi p≈ôechodu z archivu na n√°stƒõnku
  if (currentView !== view && view === 'board') {
    document.querySelectorAll('.top-day-btn').forEach(btn => {
      btn.classList.remove('top-selected');
    });
  }

  currentView = view;

  const topCal = document.getElementById('topDaySelector');
  const archiveCal = document.getElementById('archiveDaySelector');

  topCal.classList.remove('calendar-animate-left', 'calendar-animate-right');
  archiveCal.classList.remove('calendar-animate-left', 'calendar-animate-right');

  if (view === 'board') {
    topCal.classList.add('calendar-animate-left');
  }

  if (view === 'archive') {
    archiveCal.classList.add('calendar-animate-right');

    setTimeout(() => {
      archiveCal.scrollLeft = archiveCal.scrollWidth;
    }, 20);
  }

  document.getElementById('viewBoardBtn').classList.toggle('active', view === 'board');
  document.getElementById('viewArchiveBtn').classList.toggle('active', view === 'archive');

  document.getElementById('archiveSearchWrapper').style.display =
    view === 'archive' ? 'block' : 'none';

  document.querySelector('.top-calendar-wrapper').style.display =
    view === 'board' ? 'block' : 'none';

document.getElementById('boardSearchWrapper').style.display =
  view === 'board' ? 'block' : 'none';

  const archiveWrapper = document.getElementById('archiveCalendarWrapper');
  if (archiveWrapper) {
    archiveWrapper.style.display = (view === 'archive') ? 'block' : 'none';
  }

  if (view === 'archive') {
    renderArchiveCalendar();
  }

  renderReservations();
}

function openCreateModal() {
  // pokud nejsme na n√°stƒõnce, p≈ôepneme se na ni
  if (currentView !== 'board') {
    switchView('board'); // to samo resetuje archiveSearchQuery a aktivn√≠ den
  } else {
    // jsme u≈æ na n√°stƒõnce ‚Üí vyƒçist√≠me vyhled√°v√°n√≠
    boardSearchQuery = "";
    const input = document.getElementById('boardSearchInput');
    if (input) input.value = "";
    renderReservations();
  }

  editId = null;
  pendingSaveData = null;
  selectingForCreation = false;
  changingControl = false;

  document.getElementById('modalTitle').innerText = 'Nov√° rezervace';
  document.getElementById('modal').style.display = 'flex';

  document.querySelectorAll('#modal input').forEach(function(i){
    i.value = '';
    i.classList.remove('input-error');
  });

  document.getElementById('prefix').value = '+420';

  document.querySelectorAll('#daySelector .day-btn').forEach(function(b){
    b.classList.remove('selected');
  });

  document.getElementById('editControlRow').innerHTML = '';

  if (activeFilterDate) {
    var btn = document.querySelector('#daySelector .day-btn[data-date="' + activeFilterDate + '"]');
    if (btn) btn.classList.add('selected');
  }
}

function openEditModal(id) {
  const r = getReservations().find(function(x){return x.id === id;});
  if (!r) return;
  editId = id;
  pendingSaveData = null;
  selectingForCreation = false;
  changingControl = false;
  document.getElementById('modalTitle').innerText = 'Upravit rezervaci';
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('timeInput').value = r.time;
  document.getElementById('nameInput').value = r.name;
  document.getElementById('prefix').value = r.prefix;
  document.getElementById('phoneInput').value = r.phone;
  document.getElementById('emailInput').value = r.email;
  document.getElementById('carInput').value = r.car;
  document.getElementById('evcInput').value = r.evc;
  document.querySelectorAll('#modal input').forEach(function(i){ i.classList.remove('input-error'); });
  document.querySelectorAll('#daySelector .day-btn').forEach(function(b){
    b.classList.toggle('selected', b.dataset.date === r.date);
  });
  const row = document.getElementById('editControlRow');
  row.innerHTML = '';
  if (r.checked && r.controlTechnician) {
    row.innerHTML =
      '<strong>Kontrolu provedl:</strong> ' + r.controlTechnician +
      '<br><button class="btn-primary" style="margin-top:4px;" onclick="startChangeControl(\'' + r.id + '\')">Zmƒõnit technika kontroly</button>';
  }
  const card = document.querySelector('.card[data-id="' + id + '"]');
  if (card) {
    card.classList.remove('edit-highlight');
    void card.offsetWidth;
    card.classList.add('edit-highlight');
  }
}

function autoArchiveOldReservations() {
  const list = getReservations();
  const today = new Date().toISOString().split("T")[0];

  let changed = false;

  const updated = list.map(r => {
    if (!r.archived && r.date < today) {
      r.archived = true;
      changed = true;
    }
    return r;
  });

  if (changed) {
    setReservations(updated);
  }
}

let archiveSearchQuery = "";
let archiveSearchTimer = null;

function handleArchiveSearchInput(value) {
  archiveSearchQuery = value.toLowerCase();

  clearTimeout(archiveSearchTimer);
  archiveSearchTimer = setTimeout(() => {
    renderReservations();
  }, 150);
}

function matchesArchiveSearch(r) {
  if (!archiveSearchQuery) return true;

  const fields = [
    r.name,
    r.phone,
    r.email,
    r.car,
    String(r.evc),
    r.date,
    r.time
  ];

  // ignorujeme techniky
  // r.technician
  // r.controlTechnician

  const haystack = fields.join(" ").toLowerCase();
  return haystack.includes(archiveSearchQuery);
}

function toggleArchiveExpanded(id) {
  const all = getReservations();
  const r = all.find(x => x.id === id);
  if (!r) return;

  const el = document.querySelector('[data-id="' + id + '"]');
  if (!el) return;

  // ‚úÖ Pokud je u≈æ rozbalen√° ‚Üí sbalit zpƒõt
  if (el.classList.contains('archive-expanded-card')) {
    el.className = 'archive-mini-card';
    el.innerHTML = `
      <div class="archive-mini-left">
        <div class="archive-mini-time">${formatDayMonth(r.date)}</div>
        <div class="archive-mini-name">${r.name}</div>
        <div class="archive-mini-name">${r.car}</div>
      </div>
      <div class="archive-mini-evc">EVC ${r.evc}</div>
    `;

    // ‚úÖ znovu p≈ôid√°me onclick, aby ≈°la karta znovu otev≈ô√≠t
    el.onclick = function() {
      toggleArchiveExpanded(id);
    };

    return;
  }

  // ‚úÖ Zav≈ô√≠t jin√© otev≈ôen√© karty
  document.querySelectorAll('.archive-expanded-card').forEach(function(cardEl) {
    const cid = cardEl.dataset.id;
    const rr = all.find(x => x.id === cid);
    if (!rr) return;

    cardEl.className = 'archive-mini-card';
    cardEl.innerHTML = `
      <div class="archive-mini-left">
        <div class="archive-mini-time">${formatDayMonth(rr.date)}</div>
        <div class="archive-mini-name">${rr.name}</div>
        <div class="archive-mini-name">${rr.car}</div>
      </div>
      <div class="archive-mini-evc">EVC ${rr.evc}</div>
    `;

    // ‚úÖ obnov√≠me onclick
    cardEl.onclick = function() {
      toggleArchiveExpanded(cid);
    };
  });

  // ‚úÖ P≈ôepnout minikartu na velkou archivn√≠ kartu
  el.className = 'archive-expanded-card archive-expand-anim';
  el.innerHTML = `
  <div class="archive-expanded-title">${highlight(formatDayMonth(r.date) + ' ' + r.time)}</div>

  <div class="archive-expanded-line">üë§ ${highlight(r.name)}</div>
  <div class="archive-expanded-line">üìû ${r.prefix} ${highlight(r.phone)}</div>
  ${r.email ? `<div class="archive-expanded-line">‚úâÔ∏è ${highlight(r.email)}</div>` : '' }
  <div class="archive-expanded-line">üöó ${highlight(r.car)}</div>
  <div class="archive-expanded-line">Evidenƒçn√≠ ƒç√≠slo: <strong>${r.evc ? highlight(String(r.evc)) : '---'}</strong></div>

  <div class="archive-expanded-line">üìù Kartu vytvo≈ôil: <strong>${highlight(r.technician || '‚Äî')}</strong></div>
  <div class="archive-expanded-line">‚úÖ Kontrolu provedl: <strong>${highlight(r.controlTechnician || '‚Äî')}</strong></div>

  <div class="archive-expanded-close">
    <button type="button" class="archive-close-btn">Zav≈ô√≠t</button>
  </div>
`;

  // ‚úÖ expanded karta NESM√ç reagovat na kliknut√≠
  el.onclick = null;

  // ‚úÖ zav√≠rac√≠ tlaƒç√≠tko
  const closeBtn = el.querySelector('.archive-close-btn');
  closeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    toggleArchiveExpanded(id);
  });
}

function startChangeControl(id) {
  const r = getReservations().find(function(x){return x.id === id;});
  if (!r) return;
  pendingSaveData = Object.assign({}, r);
  selectingForCreation = false;
  changingControl = true;
  openNameSelect();
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function validatePhoneImmediate() {
  const prefix = document.getElementById('prefix').value;
  const phoneInput = document.getElementById('phoneInput');
  const phone = phoneInput.value.trim();
  const phoneLengths = {'+420':9,'+421':9,'+43':10,'+49':10,'+36':9,'+370':8};
  phoneInput.classList.remove('input-error');
  if (!phone) return;
  const expected = phoneLengths[prefix];
  if (phone.length !== expected) {
    phoneInput.classList.add('input-error');
    alert('Telefonn√≠ ƒç√≠slo m√° m√≠t ' + expected + ' ƒç√≠slic.');
  }
}

function cleanupOldReservations() {
  const list = getReservations();
  const now = Date.now();
  const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

  const filtered = list.filter(r => {
    if (!r.archived) return true; // ma≈æeme jen archivovan√©
    const date = new Date(r.date + "T00:00:00").getTime();
    return now - date < THIRTY_DAYS;
  });

  if (filtered.length !== list.length) {
    setReservations(filtered);
  }
}

function validateEvcDuplicateImmediate() {
  const evcInput = document.getElementById('evcInput');
  const raw = evcInput.value.trim();
  evcInput.classList.remove('input-error');
  if (!raw) return;
  const evc = parseInt(raw,10);
  if (isNaN(evc)) return;
  const list = getReservations();
  const duplicate = list.find(function(r){return r.evc === evc && r.id !== editId;});
  if (duplicate) evcInput.classList.add('input-error');
}

function validateForm(data) {
  const phoneLengths = {'+420':9,'+421':9,'+43':10,'+49':10,'+36':9,'+370':8};
  if (!data.date || !data.time || !data.name || !data.car) {
    alert('Vypl≈à datum, ƒças, jm√©no, vozidlo a evidenƒçn√≠ ƒç√≠slo.');
    return false;
  }
  if (data.phone.length !== phoneLengths[data.prefix]) {
    alert('Telefon mus√≠ m√≠t ' + phoneLengths[data.prefix] + ' ƒç√≠slic.');
    return false;
  }
  if (data.email && (data.email.indexOf('@')===-1 || data.email.indexOf('.')===-1)) {
    alert('E‚Äëmail mus√≠ obsahovat "@" a ".".');
    return false;
  }
  if (data.evc && (data.evc < 1 || data.evc > 250)) {
  alert('Evidenƒçn√≠ ƒç√≠slo mus√≠ b√Ωt 1‚Äì250.');
  return false;
}
  return true;
}

function saveReservation() {
  const selectedDay = document.querySelector('#daySelector .day-btn.selected');
  const date = selectedDay ? selectedDay.dataset.date : '';
  const old = editId ? getReservations().find(function(r){return r.id === editId;}) : {};
  const rawTime = document.getElementById('timeInput').value;
let normalizedTime = rawTime;

if (rawTime) {
  const parts = rawTime.split(':');
  const h = (parts[0] || '00').padStart(2, '0');
  normalizedTime = h + ':00';
}

const data = {
  date: date,
  time: normalizedTime,
  name: document.getElementById('nameInput').value.trim(),
  prefix: document.getElementById('prefix').value,
  phone: document.getElementById('phoneInput').value.trim(),
  email: document.getElementById('emailInput').value.trim(),
  car: document.getElementById('carInput').value.trim(),
  evc: document.getElementById('evcInput').value.trim()
      ? parseInt(document.getElementById('evcInput').value.trim(),10)
      : null,
  checked: old && old.checked || false,
  technician: old && old.technician || null,
  controlTechnician: old && old.controlTechnician || null
};
  if (!validateForm(data)) return;
  const list = getReservations();
  const duplicate = list.find(function(r){return r.evc === data.evc && r.id !== editId;});
  if (duplicate) {
    alert('Pozor: toto evidenƒçn√≠ ƒç√≠slo je ji≈æ na n√°stƒõnce. Ukl√°d√°n√≠ je povoleno.');
  }
  pendingSaveData = data;
  if (editId) {
    finalizeSave(pendingSaveData);
    pendingSaveData = null;
    return;
  }
  selectingForCreation = true;
  changingControl = false;
  openNameSelect();
}

function finalizeSave(data) {
  let list = getReservations();
  if (editId) {
    list = list.map(function(r){
      if (r.id === editId) {
        return Object.assign(
          {
            id: editId,
            createdAt: r.createdAt || Date.now(),
            archived: r.archived || false
          },
          data
        );
      }
      return r;
    });
    lastSavedId = editId;
  } else {
    const newId = Date.now().toString();
    list.push(Object.assign({
      id: newId,
      createdAt: Date.now(),
      archived: false
    }, data));
    lastSavedId = newId;
  }
  setReservations(list);
  renderReservations();
  closeModal();
  setTimeout(function(){ lastSavedId = null; }, 1500);
}

function openNameSelect() {
  document.getElementById('nameSelectModal').style.display = 'flex';
}
function closeNameSelect() {
  document.getElementById('nameSelectModal').style.display = 'none';
}
function selectTechnician(name) {
  if (!pendingSaveData) return;
  if (selectingForCreation) {
    pendingSaveData.technician = name;
    finalizeSave(pendingSaveData);
  } else if (changingControl) {
    const evc = pendingSaveData.evc;
    let list = getReservations();
    list = list.map(function(r){
      if (r.evc === evc) {
        r.checked = true;
        r.controlTechnician = name;
      }
      return r;
    });
    setReservations(list);
    renderReservations();
  }
  pendingSaveData = null;
  selectingForCreation = false;
  changingControl = false;
  closeNameSelect();
}

function deleteCard(id) {
  if (!confirm('Opravdu chce≈° smazat tuto kartu?')) return;

  let list = getReservations().filter(function(r){
    return r.id !== id;
  });

  setReservations(list);
  renderReservations();
  updateSwitchCounts();   // ‚úÖ doplnƒõno ‚Äì aktualizace poƒç√≠tadel po smaz√°n√≠
}

function toggleControl(id) {
  const r = getReservations().find(function(x){return x.id === id;});
  if (!r || r.checked) return;
  pendingSaveData = Object.assign({}, r);
  selectingForCreation = false;
  changingControl = true;
  openNameSelect();
}

function jumpToNextDuplicate(evc, currentId) {

  // pokud je aktivn√≠ filtr ‚Üí vypneme ho, aby byly vidƒõt v≈°echny duplicity
  if (activeFilterDate) {
    activeFilterDate = null;
    renderReservations();
  }

  const cards = Array.prototype.slice.call(document.querySelectorAll('.card'));
  const dupes = cards.filter(function(c){ return c.dataset.evc == evc; });

  if (dupes.length <= 1) return;

  const index = dupes.findIndex(function(c){ return c.dataset.id == currentId; });
  const next = dupes[(index + 1) % dupes.length];

  if (next) next.scrollIntoView({behavior:'smooth', block:'center'});

  dupes.forEach(function(c){
    c.classList.remove('jump-highlight');
    void c.offsetWidth;
    c.classList.add('jump-highlight');
  });
}
function computeDayCounts() {
  const list = getReservations();
  const counts = {};
  list.forEach(function(r){
    if (!r.date) return;
    counts[r.date] = (counts[r.date] || 0) + 1;
  });
  return counts;
}

function updateDayBadges() {
  // poƒçty rezervac√≠ na den (p≈Øvodn√≠ logika)
  const counts = computeDayCounts();

  // p≈ôiprav√≠me data pro duplicity podle dne a EVC
  const list = getReservations();
  const evcCounts = {};
  const dayEvcCounts = {};

  list.forEach(function(r){

    // ‚úÖ IGNORUJ ARCHIVOVAN√â REZERVACE
    if (r.archived) return;

    if (!r.evc && r.evc !== 0) return;

    // glob√°ln√≠ poƒçet v√Ωskyt≈Ø EVC (pro urƒçen√≠, jestli je to duplicita)
    evcCounts[r.evc] = (evcCounts[r.evc] || 0) + 1;

    if (!r.date) return;
    if (!dayEvcCounts[r.date]) dayEvcCounts[r.date] = {};
    dayEvcCounts[r.date][r.evc] = (dayEvcCounts[r.date][r.evc] || 0) + 1;
  });

  document.querySelectorAll('.day-btn, .top-day-btn').forEach(function(btn){
    const date = btn.dataset.date;

    // sma≈æeme star√© badge i teƒçky
    btn.querySelectorAll('.day-badge').forEach(function(b){ b.remove(); });
    btn.querySelectorAll('.day-duplicate-dot').forEach(function(d){ d.remove(); });

    // badge s poƒçtem rezervac√≠
    const count = counts[date] || 0;
    if (count > 0) {
      const badge = document.createElement('div');
      badge.className = 'day-badge';
      badge.textContent = count;
      btn.appendChild(badge);
    }

    // teƒçky duplicit
    const evcMap = dayEvcCounts[date] || {};
    const duplicatesForDay = Object.keys(evcMap)
      .filter(function(evc){
        return evcCounts[evc] > 1;
      })
      .map(function(evc){
        return {
          evc: parseInt(evc, 10),
          count: evcMap[evc]
        };
      });

    duplicatesForDay.forEach(function(dup, index){
      const dot = document.createElement('div');
      dot.className = 'day-duplicate-dot';
      dot.style.top = (4 + index * 14) + 'px';
      dot.style.background = getColorForEvc(dup.evc);
      dot.textContent = dup.count;
      btn.appendChild(dot);
    });
  });
}

function updateFilterInfo() {
  const info = document.getElementById('filterInfo');
  const label = document.getElementById('filterLabel');
  if (activeFilterDate) {
    info.style.display = 'block';
    label.textContent = formatDayMonth(activeFilterDate);
  } else {
    info.style.display = 'none';
  }
}

function renderReservations() {
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '';
  autoArchiveOldReservations();
  cleanupOldReservations();
  let list = getReservations();
  // ‚úÖ Rozdƒõlen√≠ dat podle zobrazen√≠
  if (currentView === 'board') {
    // n√°stƒõnka = jen nearchivovan√©
    list = list.filter(r => !r.archived);
  } else {
    // archiv = jen archivovan√©
    list = list.filter(r => r.archived);
  }

  // ‚úÖ vyhled√°v√°n√≠ jen v archivu
  if (currentView === 'archive') {
    list = list.filter(matchesArchiveSearch);
  }

if (currentView === 'board') {
  list = list.filter(matchesBoardSearch);
}

  list.sort(function(a,b){
    return (a.date + a.time).localeCompare(b.date + b.time);
  });
  if (activeFilterDate) {
    list = list.filter(function(r){return r.date === activeFilterDate;});
  }
  // poƒç√≠t√°me duplicity GLOB√ÅLNƒö, ne podle filtru
  const all = getReservations();
  const evcCounts = {};

  all.forEach(function(r){
    // üîπ ignoruj archivovan√© karty pro logiku duplicit na n√°stƒõnce
    if (r.archived) return;

    if (!r.evc && r.evc !== 0) return;
    evcCounts[r.evc] = (evcCounts[r.evc] || 0) + 1;
  });
  // ‚úÖ Mus√≠me pou≈æ√≠t cel√Ω seznam, ne filtrovan√Ω

  const evcControl = {};

  all.forEach(function(r){
    if (!r.archived && r.evc && r.checked && r.controlTechnician) {
      evcControl[r.evc] = r.controlTechnician;
    }
  });

  list.forEach(function(r){

    if (currentView === 'archive') {
      const mini = document.createElement('div');
      mini.className = 'archive-mini-card';
      mini.dataset.id = r.id;

      mini.innerHTML = `
  <div class="archive-mini-left">
    <div class="archive-mini-time">${highlight(formatDayMonth(r.date))}</div>
    <div class="archive-mini-name">${highlight(r.name)}</div>
    <div class="archive-mini-name">${highlight(r.car)}</div>
  </div>
  <div class="archive-mini-evc">EVC ${r.evc ? highlight(String(r.evc)) : '---'}</div>
`;

      mini.onclick = function() {
        toggleArchiveExpanded(r.id);
      };

      container.appendChild(mini);
      return; // ‚úÖ p≈ôeskoƒç√≠me velkou kartu
    }

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = r.id;
    card.dataset.evc = r.evc;

    const groupTech = r.evc ? evcControl[r.evc] : null;
    const isGroupChecked = !!groupTech;
    const isChecked = r.checked || isGroupChecked;

    if (isChecked) card.classList.add('green');
    if (lastSavedId && r.id === lastSavedId) card.classList.add('success-flash');

    const formattedDate = formatDate(r.date, r.time);
    const checkboxHTML = isChecked ? '' :
      '<label class="check-wrapper"><input type="checkbox"><span>Kontrola provedena</span></label>';

    let isDuplicate = false;
    let dupColor = null;

    if (currentView === 'board') {
      isDuplicate = r.evc && evcCounts[r.evc] > 1;
      dupColor = isDuplicate ? getColorForEvc(r.evc) : null;
    }

    if (isDuplicate){
      // ‚úÖ svƒõtlej≈°√≠ duplicitn√≠ barva pro pozad√≠ karty
      const start = dupColor.replace('hsl','hsla').replace(')',',0.09)');
      const mid   = dupColor.replace('hsl','hsla').replace(')',',0.0)');

      card.style.setProperty('--dup-bg-color-start', start);
      card.style.setProperty('--dup-bg-color-mid', mid);

      card.classList.add('card-duplicate-bg');
    }
    let stripColor = '';
    if (isChecked && isDuplicate) {
      stripColor = 'linear-gradient(to bottom,' 
        + dupColor + ' 1%,' 
        + dupColor + ' 10%,' 
        + '#4caf50 30%)';

    } else if (isChecked) {
      stripColor = '#4caf50';
    } else if (isDuplicate) {
      stripColor = dupColor;
    }

    const stripHTML = stripColor ? '<div class="status-strip" style="background:' + stripColor + ';"></div>' : '';
    const dotHTML = isDuplicate ? '<div class="duplicate-dot" style="background:' + dupColor + ';"></div>' : '';
    const badgeHTML = isDuplicate
      ? '<div class="duplicate-badge" onclick="jumpToNextDuplicate(' + r.evc + ', \'' + r.id + '\')" ' +
        'data-tooltip="Klikni pro p≈ôeskoƒçen√≠ na dal≈°√≠ kartu s t√≠mto EVC" ' +
        'style="background:' + dupColor + ';">' +
        '‚ö† DUPLICITA (EVC ' + r.evc + ' ‚Ä¢ ' + evcCounts[r.evc] + '√ó)</div>'
      : '';

var emailLine = r.email ? '‚úâÔ∏è ' + highlight(r.email) + '<br>' : '';
var techLine = r.technician
  ? '<br><br>üìù Kartu vytvo≈ôil: <strong>' + highlight(r.technician) + '</strong>'
  : '';
var controlNameToShow = groupTech || r.controlTechnician || '';
var controlLine = controlNameToShow
  ? '<br>‚úÖ Kontrolu provedl: <strong>' + highlight(controlNameToShow) + '</strong>'
  : '';

var infoHtml =
  '<strong>üìÖ ' + highlight(formattedDate) + '</strong><br>' +
  'üë§ ' + highlight(r.name) + '<br>' +
  'üìû ' + r.prefix + ' ' + highlight(r.phone) + '<br>' +
  emailLine +
  'üöó ' + highlight(r.car) + '<br>' +
  'Evidenƒçn√≠ ƒç√≠slo: <strong>' + (r.evc ? highlight(String(r.evc)) : '---') + '</strong>' +
  techLine +
  controlLine +
  checkboxHTML;    

    card.innerHTML =
      stripHTML +
      dotHTML +
      badgeHTML +
      '<div class="card-info">' + infoHtml + '</div>' +
      '<div class="actions">' +
        '<div class="actions-row">' +
          '<button class="icon-btn edit-btn">‚úèÔ∏è</button>' +
          '<button class="icon-btn delete-btn">üóëÔ∏è</button>' +
        '</div>' +
      '</div>';

    if (!isChecked) {
      const cb = card.querySelector("input[type='checkbox']");
      if (cb) cb.addEventListener('change', function(){ toggleControl(r.id); });
    }
    card.querySelector('.edit-btn').onclick = function(){ openEditModal(r.id); };
    card.querySelector('.delete-btn').onclick = function(){ deleteCard(r.id); };

    if (currentView === 'board' && isDuplicate) {
      card.addEventListener('mouseenter', function(){
        document.querySelectorAll('.card[data-evc="' + r.evc + '"]').forEach(function(c){
          c.classList.add('duplicate-hover');
        });
      });
      card.addEventListener('mouseleave', function(){
        document.querySelectorAll('.card[data-evc="' + r.evc + '"]').forEach(function(c){
          c.classList.remove('duplicate-hover');
        });
      });
    }

    container.appendChild(card);
  });

  updateDayBadges();
  updateFilterInfo();
}

function updateSwitchCounts() {
  const list = getReservations();
  const board = list.filter(r => !r.archived).length;
  const archive = list.filter(r => r.archived).length;

  document.getElementById('boardCount').textContent = board;
  document.getElementById('archiveCount').textContent = archive;
}

const daySelector = document.getElementById('daySelector');
const days = ['Ne','Po','√öt','St','ƒåt','P√°','So'];
let totalDaysGenerated = 0;

function generateDays(count) {
  const today = new Date();
  while (count-- > 0 && totalDaysGenerated < 14) {
    const d = new Date();
    d.setDate(today.getDate() + totalDaysGenerated);
    const btn = document.createElement('div');
    btn.style.setProperty('--i', totalDaysGenerated);
    btn.className = 'day-btn';
    btn.dataset.date = d.toISOString().split('T')[0];
    btn.innerHTML = days[d.getDay()] + '<br><strong>' + formatDayMonth(d.toISOString().split("T")[0]) + '</strong>';
    if (d.getDay() === 0 || d.getDay() === 6) btn.classList.add('weekend');
    btn.onclick = function(){
      document.querySelectorAll('.day-btn').forEach(function(b){ b.classList.remove('selected'); });
      btn.classList.add('selected');
    };
    daySelector.appendChild(btn);
    totalDaysGenerated++;
  }
  updateDayBadges();
}

generateDays(14);

const topDaySelector = document.getElementById('topDaySelector');
let topDaysGenerated = 0;

function generateTopDays(count) {
  const today = new Date();
  while (count-- > 0 && topDaysGenerated < 14) {
    const d = new Date();
    d.setDate(today.getDate() + topDaysGenerated);
    const btn = document.createElement('div');
    btn.style.setProperty('--i', topDaysGenerated);
    btn.className = 'top-day-btn';
    btn.dataset.date = d.toISOString().split('T')[0];
    btn.innerHTML = days[d.getDay()] + '<br><strong>' + formatDayMonth(d.toISOString().split("T")[0]) + '</strong>';
    if (d.getDay() === 0 || d.getDay() === 6) btn.classList.add('top-weekend');
    btn.onclick = function(){
      if (activeFilterDate === btn.dataset.date) {
        activeFilterDate = null;
        document.querySelectorAll('.top-day-btn').forEach(function(b){ b.classList.remove('top-selected'); });
      } else {
        activeFilterDate = btn.dataset.date;
        document.querySelectorAll('.top-day-btn').forEach(function(b){ b.classList.remove('top-selected'); });
        btn.classList.add('top-selected');
      }
      renderReservations();
      updateSwitchCounts();   // ‚úÖ doplnƒõno
      switchView('board');
    };
    topDaySelector.appendChild(btn);
    topDaysGenerated++;
  }
  updateDayBadges();
}

generateTopDays(14);

document.getElementById('phoneInput').addEventListener('blur', validatePhoneImmediate);
document.getElementById('prefix').addEventListener('change', function(){
  document.getElementById('phoneInput').classList.remove('input-error');
});
document.getElementById('evcInput').addEventListener('blur', validateEvcDuplicateImmediate);

// ‚úÖ Defaultn√≠ stav po naƒçten√≠ ‚Äì aktivn√≠ N√°stƒõnka
window.addEventListener('DOMContentLoaded', () => {
  switchView('board');
  updateSwitchCounts();   // ‚úÖ doplnƒõno
});
</script>

</body>
</html>